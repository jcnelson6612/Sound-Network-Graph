<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relational Soundscape Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- GLASSMORPHISM & ANIMATED BACKGROUND --- */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background: linear-gradient(-45deg, #1a1c2c, #4a192c, #233e4a, #0f1016);
            background-size: 400% 400%;
            animation: gradientBG 25s ease infinite;
            color: #e2e8f0;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Glass Panel Styling */
        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .node {
            cursor: pointer;
            transition: opacity 0.4s ease;
        }

        /* Text Styling for Dark Mode */
        .node text {
            font-weight: 300;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            pointer-events: none;
            transition: opacity 0.4s ease, font-weight 0.2s;
        }
        
        .node:hover text {
            font-weight: 600;
            fill: #fff !important;
        }

        .node:hover circle {
            filter: drop-shadow(0 0 8px rgba(255,255,255,0.6));
        }

        .link {
            transition: stroke-opacity 0.4s ease;
        }

        /* Custom Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 0 4px rgba(0,0,0,0.5);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
        }

        /* Settings Panel Transition */
        #settings-panel {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .hidden-panel {
            transform: translateX(120%);
            opacity: 0;
            pointer-events: none;
        }
        
        /* Playback Control Buttons */
        .control-btn {
            transition: background-color 0.2s, transform 0.1s;
        }
        .control-btn:active {
            transform: scale(0.95);
        }
        .control-btn.active-mode {
            background-color: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
        }
    </style>
</head>
<body>

    <!-- Controls Container: Search + Play/Stop -->
    <div class="absolute top-6 left-6 z-10 flex gap-3 items-center">
        <!-- Search Bar -->
        <input type="text" id="search-bar" placeholder="Search sounds..." 
               class="glass-panel rounded-full px-6 py-3 text-white placeholder-gray-300 focus:ring-2 focus:ring-white/30 focus:outline-none transition w-64 text-sm tracking-wide">
        
        <!-- Play Button (Auto Cycle) -->
        <button id="btn-play" class="control-btn glass-panel rounded-full p-3 text-white hover:bg-white/20" title="Auto-Cycle (30s)">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
        </button>

        <!-- Stop Button -->
        <button id="btn-stop" class="control-btn glass-panel rounded-full p-3 text-white hover:bg-white/20" title="Stop All">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            </svg>
        </button>
    </div>

    <!-- Settings Toggle Button -->
    <button id="settings-toggle" class="absolute top-6 right-6 z-20 glass-panel rounded-full p-3 hover:bg-white/20 transition text-white">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
    </button>

    <!-- Settings Panel -->
    <div id="settings-panel" class="absolute top-20 right-6 z-10 glass-panel rounded-xl p-6 w-72 text-white hidden-panel flex flex-col gap-4 max-h-[80vh] overflow-y-auto">
        <h3 class="font-semibold text-lg border-b border-white/20 pb-2 mb-2">Visual Settings</h3>
        
        <div class="flex flex-col gap-1">
            <label class="text-xs text-gray-300 flex justify-between">Base Node Opacity <span id="val-opacity">0.15</span></label>
            <input type="range" id="input-opacity" min="0" max="1" step="0.05" value="0.15" class="w-full">
        </div>

        <div class="flex flex-col gap-1">
            <label class="text-xs text-gray-300 flex justify-between">Base Link Opacity <span id="val-link">0.7</span></label>
            <input type="range" id="input-link" min="0" max="1" step="0.01" value="0.7" class="w-full">
        </div>
        
        <div class="flex flex-col gap-1">
            <label class="text-xs text-gray-300 flex justify-between">Inactive Node Opacity <span id="val-inactive-node">0.35</span></label>
            <input type="range" id="input-inactive-node" min="0" max="1" step="0.05" value="0.35" class="w-full">
        </div>

        <div class="flex flex-col gap-1">
            <label class="text-xs text-gray-300 flex justify-between">Inactive Link Opacity <span id="val-inactive-link">0.15</span></label>
            <input type="range" id="input-inactive-link" min="0" max="1" step="0.01" value="0.15" class="w-full">
        </div>

        <div class="flex flex-col gap-1">
            <label class="text-xs text-gray-300 flex justify-between">Glare Strength <span id="val-glare">0.25</span></label>
            <input type="range" id="input-glare" min="0" max="1" step="0.05" value="0.25" class="w-full">
        </div>

        <div class="flex flex-col gap-1">
            <label class="text-xs text-gray-300 flex justify-between">Node Size <span id="val-size">20</span></label>
            <input type="range" id="input-size" min="5" max="50" step="1" value="20" class="w-full">
        </div>

        <div class="flex flex-col gap-1">
            <label class="text-xs text-gray-300 flex justify-between">Stroke Weight <span id="val-stroke">0.5</span></label>
            <input type="range" id="input-stroke" min="0" max="5" step="0.5" value="0.5" class="w-full">
        </div>

        <h3 class="font-semibold text-lg border-b border-white/20 pb-2 mb-2 mt-2">Physics</h3>

        <div class="flex flex-col gap-1">
            <label class="text-xs text-gray-300 flex justify-between">Force/Gravity <span id="val-charge">-600</span></label>
            <input type="range" id="input-charge" min="-2000" max="-50" step="50" value="-600" class="w-full">
        </div>

        <div class="flex flex-col gap-1">
            <label class="text-xs text-gray-300 flex justify-between">Link Distance <span id="val-distance">220</span></label>
            <input type="range" id="input-distance" min="50" max="500" step="10" value="220" class="w-full">
        </div>

        <h3 class="font-semibold text-lg border-b border-white/20 pb-2 mb-2 mt-2">Audio</h3>

        <div class="flex flex-col gap-1">
            <label class="text-xs text-gray-300 flex justify-between">Master Volume <span id="val-volume">1.0</span></label>
            <input type="range" id="input-volume" min="0" max="2" step="0.1" value="1.0" class="w-full">
        </div>

        <div class="flex flex-col gap-1">
            <label class="text-xs text-gray-300 flex justify-between">Max Neighbors <span id="val-neighbors">4</span></label>
            <input type="range" id="input-neighbors" min="0" max="10" step="1" value="4" class="w-full">
        </div>
    </div>

    <div id="graph-container" class="w-screen h-screen"></div>
    
    <script>
        // --- DATA ---
        const soundscapeData = {
            nodes: [
  {
    "id": "Water Lapping",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1759891854/Water_Lapping_jqk7hz.mp3",
    "group": "all"
  },
  {
    "id": "Sunflower Stalk",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746229/Sunflower_Stalk_1_noe3k6.mp3",
    "group": "all"
  },
  {
    "id": "Squash Vine",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746222/Squash_Vine_1_s1yhrk.mp3",
    "group": "all"
  },
  {
    "id": "Sirens and Rowers",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746297/Sirens_and_Rowers_f4j9q3.mp3",
    "group": "all"
  },
  {
    "id": "Shaking Dead Tree",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746228/Shaking_Dead_Tree_3_j3qjax.mp3",
    "group": "all"
  },
  {
    "id": "Rustling Squash Leaves",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746214/Rustling_Squash_Leaves_Between_Fingers_nhvtxf.mp3",
    "group": "all"
  },
  {
    "id": "Rubbing Leaves",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746201/Rubbing_Leaf_with_Fingers_yvld6g.mp3",
    "group": "all"
  },
  {
    "id": "Rowers",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746291/Rowers_udw3ck.mp3",
    "group": "all"
  },
  {
    "id": "Tomato Plants",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746022/Rick_s_Tomato_Plants_jqs8pe.mp3",
    "group": "all"
  },
  {
    "id": "Stomping",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746022/Rick_s_Stomping_nnajdb.mp3",
    "group": "all"
  },
  {
    "id": "Beanstalk",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746023/Rick_s_Beanstalk_np33xb.mp3",
    "group": "all"
  },
  {
    "id": "Basil Plant",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746022/Rick_s_Basil_Plant_yoh8cp.mp3",
    "group": "all"
  },
  {
    "id": "Watering Plants",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760809458/Rick_Watering_Plants_lgi8lq.mp3",
    "group": "all"
  },
  {
    "id": "Motorcycle Idling",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746200/Motorcycle_Idling_qig8ga.mp3",
    "group": "all"
  },
  {
    "id": "Birdsong 1",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746199/Misc_Birdsong_yrgh0k.mp3",
    "group": "all"
  },
  {
    "id": "Birdsong 2",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746203/Misc_Birdsong_2_xjl2lo.mp3",
    "group": "all"
  },
  {
    "id": "Log Tapping",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746257/Log_Tapping_a5at0k.mp3",
    "group": "all"
  },
  {
    "id": "Log Scraping",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746283/Log_Scraping_1_vicubf.mp3",
    "group": "all"
  },
  {
    "id": "Log Falling",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746261/Log_Falling_1_timqfi.mp3",
    "group": "all"
  },
  {
    "id": "Light Ballast",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746200/Light_Ballast_by_Loud_Road_xjhp6f.mp3",
    "group": "all"
  },
  {
    "id": "Windy Leaves",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746311/Leaves_Wind_2_ikh50v.mp3",
    "group": "all"
  },
  {
    "id": "Brushing against Plants",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746217/Leaves_Brushing_Against_Leg_nlt0ga.mp3",
    "group": "all"
  },
  {
    "id": "Road Noises",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746209/Generic_Road_Noise_hlpvoi.mp3",
    "group": "all"
  },
  {
    "id": "Ambience",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746319/General_Park_Ambience_sscrca.mp3",
    "group": "all"
  },
  {
    "id": "Footsteps",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746267/Footsteps_1_bp4wzm.mp3",
    "group": "all"
  },
  {
    "id": "Helicopter Landing",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746235/Enter_Gate_and_Helicopter_Landing_shr0ib.mp3",
    "group": "all"
  },
  {
    "id": "Ducks Bathing",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746234/Ducks_Bathing_x5pnyy.mp3",
    "group": "all"
  },
  {
    "id": "Dropping Leaves",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746280/Dropping_Leaves_2_fqo55b.mp3",
    "group": "all"
  },
  {
    "id": "Learning about Roots",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746290/Digging_with_Will_Dialogue_2_gy3941.mp3",
    "group": "all"
  },
  {
    "id": "Digging",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746261/Digging_2_rpwiby.mp3",
    "group": "all"
  },
  {
    "id": "Crickets",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746269/Crickets_d9wqf9.mp3",
    "group": "all"
  },
  {
    "id": "Crickets and Airplane",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746279/Cricket_and_Airplane_wl1joa.mp3",
    "group": "all"
  },
  {
    "id": "Cicadas",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1759890566/Cicadas_mje4ok.mp3",
    "group": "all"
  },
  {
    "id": "Car Acceleration",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746211/Car_Acceleration_at_Stoplight_lehbxk.mp3",
    "group": "all"
  },
  {
    "id": "Breathing",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746252/Breathing_adlyw8.mp3",
    "group": "all"
  },
  {
    "id": "Crunching Branches",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746247/Branches_Crunching_jjfgaf.mp3",
    "group": "all"
  },
  {
    "id": "Breaking Branches",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746246/Branches_Breaking_pb1iup.mp3",
    "group": "all"
  },
  {
    "id": "Birdsong/Car Noise",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746023/Birdsong_with_car_hum_s78bzd.mp3",
    "group": "all"
  },
  {
    "id": "Bird/Siren",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746239/Bird_and_Siren_sk5h7g.mp3",
    "group": "all"
  },
  {
    "id": "Birds and Ducks",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746209/Bird_and_Duck_Songs_bprrjg.mp3",
    "group": "all"
  },
  {
    "id": "Bird Drops her Nut",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746204/Bird_Drops_Her_Nut_bmzc0p.mp3",
    "group": "all"
  },
  {
    "id": "Bird Call 1",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746240/Bird_Call_1_tunkh9.mp3",
    "group": "all"
  },
  {
    "id": "Bird Call 2",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746244/Bird_Call_2_ltsyhv.mp3",
    "group": "all"
  },
  {
    "id": "Bike",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746239/Bicycle_Sprocket_Clicking_wlgl6p.mp3",
    "group": "all"
  },
  {
    "id": "Bees 1",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746290/Bees_1_ihrp3l.mp3",
    "group": "all"
  },
  {
    "id": "Bees 2",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746291/Bees_2_dglpio.mp3",
    "group": "all"
  },
  {
    "id": "Bees 3",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746304/Bees_3_l9daze.mp3",
    "group": "all"
  },
  {
    "id": "Bees 4",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746283/Bees_4_rqgjvm.mp3",
    "group": "all"
  },
  {
    "id": "Bees 5",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801210/Bee_Buzzing_zsmjb6.mp3",
    "group": "all"
  },
  {
    "id": "Airplane",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760746305/Airplane_ohi0po.mp3",
    "group": "all"
  },
  {
    "id": "Children's Speech",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801289/Children_s_Speech_jph9g6.mp3",
    "group": "all"
  },
  {
    "id": "Shed Floor",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801230/Shed_Floor_bcdzay.mp3",
    "group": "all"
  },
  {
    "id": "Scraping Bottles",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801227/Scraping_Bottles_1_kxqpig.mp3",
    "group": "all"
  },
  {
    "id": "Shaking Metal Tower",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801229/Shaking_Metal_Tower_wszwdb.mp3",
    "group": "all"
  },
  {
    "id": "Rattling Metal Tower",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801225/Rattling_Metal_Tower_me4hur.mp3",
    "group": "all"
  },
  {
    "id": "Pounding Metal Tower",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801224/Pounding_on_Metal_Tower_lhzeo1.mp3",
    "group": "all"
  },
  {
    "id": "Tapping Metal Tower",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801204/Tapping_on_Metal_Tower_cronn6.mp3",
    "group": "all"
  },
  {
    "id": "Opening Latch",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801222/Opening_Latch_zpsxse.mp3",
    "group": "all"
  },
  {
    "id": "Leaf Rustling in Hand",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801221/Leaf_Rustling_drd07r.mp3",
    "group": "all"
  },
  {
    "id": "Insect Repellant",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801221/Insect_Repellant_mmfezb.mp3",
    "group": "all"
  },
  {
    "id": "Hose Handle",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801218/Hose_Handle_rga673.mp3",
    "group": "all"
  },
  {
    "id": "Gardener Talking",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801218/Gardener_Talking_lqpfpl.mp3",
    "group": "all"
  },
  {
    "id": "Eating Tomato",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801216/Eating_Tomato_gxmri4.mp3",
    "group": "all"
  },
  {
    "id": "Drawer in Shed",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801215/Drawer_in_Shed_bexw9k.mp3",
    "group": "all"
  },
  {
    "id": "Door Slam",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801214/Door_Slam_lfhpyi.mp3",
    "group": "all"
  },
  {
    "id": "Door Hinge",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801213/Door_Hinge_1_dlckav.mp3",
    "group": "all"
  },
  {
    "id": "Nails in Shed",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801211/Box_of_Nails_in_Shed_mg5syl.mp3",
    "group": "all"
  },
  {
    "id": "Asking a Question",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801209/Asking_a_Question_tut4ya.mp3",
    "group": "all"
  },
  {
    "id": "Wood Tapping",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801207/Wood_Tapping_mlw68z.mp3",
    "group": "all"
  },
  {
    "id": "Wood Scraping",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801207/Wood_Scraping_k4rkt0.mp3",
    "group": "all"
  },
  {
    "id": "Water Timer Clicking",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801205/Water_Timer_Clicking_cmlpvm.mp3",
    "group": "all"
  },
  {
    "id": "Sound Artist Conversation",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760801203/Sound_Artist_Conversation_w1rua7.mp3",
    "group": "all"
  },
  {
    "id": "Heartbeat",
    "sound": "https://res.cloudinary.com/dxvjtqgka/video/upload/v1760816761/Heartbeat_Simplified_esmeso.mp3",
    "group": "all"
  },
  {
    "id": "Infrastructure",
    "sound": "",
    "group": "category"
  },
  {
    "id": "Machines",
    "sound": "",
    "group": "category"
  },
  {
    "id": "Labor",
    "sound": "",
    "group": "category"
  },
  {
    "id": "Body",
    "sound": "",
    "group": "category"
  },
  {
    "id": "Flora",
    "sound": "",
    "group": "category"
  },
  {
    "id": "Fauna",
    "sound": "",
    "group": "category"
  },
  {
    "id": "Community",
    "sound": "",
    "group": "category"
  },
  {
    "id": "Earth",
    "sound": "",
    "group": "category"
  }
],
            links: 
            [
  {
    "source": "Heartbeat",
    "targets": "Breathing, Footsteps"
  },
  {
    "source": "Water Lapping",
    "targets": ""
  },
  {
    "source": "Sunflower Stalk",
    "targets": ""
  },
  {
    "source": "Squash Vine",
    "targets": "Rustling Squash Leaves"
  },
  {
    "source": "Sirens and Rowers",
    "targets": ""
  },
  {
    "source": "Shaking Dead Tree",
    "targets": "Log Tapping, Log Scraping, Log Falling, Dropping Leaves"
  },
  {
    "source": "Rustling Squash Leaves",
    "targets": ""
  },
  {
    "source": "Rubbing Leaves",
    "targets": "Leaf Rustling in Hand"
  },
  {
    "source": "Rowers",
    "targets": ""
  },
  {
    "source": "Tomato Plants",
    "targets": ""
  },
  {
    "source": "Stomping",
    "targets": ""
  },
  {
    "source": "Beanstalk",
    "targets": ""
  },
  {
    "source": "Basil Plant",
    "targets": ""
  },
  {
    "source": "Watering Plants",
    "targets": "Hose Handle, Water Timer Clicking, Opening Latch"
  },
  {
    "source": "Motorcycle Idling",
    "targets": ""
  },
  {
    "source": "Birdsong 1",
    "targets": "Birdsong 2, Bird Call 1, Bird Call 2, Birdsong/Car Noise"
  },
  {
    "source": "Birdsong 2",
    "targets": ""
  },
  {
    "source": "Log Tapping",
    "targets": ""
  },
  {
    "source": "Log Scraping",
    "targets": ""
  },
  {
    "source": "Log Falling",
    "targets": ""
  },
  {
    "source": "Light Ballast",
    "targets": ""
  },
  {
    "source": "Windy Leaves",
    "targets": "Sunflower Stalk"
  },
  {
    "source": "Brushing against Plants",
    "targets": "Squash Vine, Sunflower Stalk"
  },
  {
    "source": "Road Noises",
    "targets": "Car Acceleration, Motorcycle Idling"
  },
  {
    "source": "Ambience",
    "targets": ""
  },
  {
    "source": "Footsteps",
    "targets": "Stomping, Crunching Branches"
  },
  {
    "source": "Helicopter Landing",
    "targets": ""
  },
  {
    "source": "Ducks Bathing",
    "targets": ""
  },
  {
    "source": "Dropping Leaves",
    "targets": ""
  },
  {
    "source": "Learning about Roots",
    "targets": ""
  },
  {
    "source": "Digging",
    "targets": ""
  },
  {
    "source": "Crickets",
    "targets": ""
  },
  {
    "source": "Crickets and Airplane",
    "targets": ""
  },
  {
    "source": "Cicadas",
    "targets": ""
  },
  {
    "source": "Car Acceleration",
    "targets": ""
  },
  {
    "source": "Breathing",
    "targets": "Footsteps, Windy Leaves"
  },
  {
    "source": "Crunching Branches",
    "targets": ""
  },
  {
    "source": "Breaking Branches",
    "targets": "Shaking Dead Tree"
  },
  {
    "source": "Birdsong/Car Noise",
    "targets": ""
  },
  {
    "source": "Bird/Siren",
    "targets": ""
  },
  {
    "source": "Birds and Ducks",
    "targets": ""
  },
  {
    "source": "Bird Drops her Nut",
    "targets": ""
  },
  {
    "source": "Bird Call 1",
    "targets": ""
  },
  {
    "source": "Bird Call 2",
    "targets": ""
  },
  {
    "source": "Bike",
    "targets": ""
  },
  {
    "source": "Bees 1",
    "targets": "Bees 2, Bees 3, Bees 4, Bees 5"
  },
  {
    "source": "Bees 2",
    "targets": ""
  },
  {
    "source": "Bees 3",
    "targets": ""
  },
  {
    "source": "Bees 4",
    "targets": ""
  },
  {
    "source": "Bees 5",
    "targets": ""
  },
  {
    "source": "Airplane",
    "targets": ""
  },
  {
    "source": "Children's Speech",
    "targets": ""
  },
  {
    "source": "Shed Floor",
    "targets": "Opening Latch, Drawer in Shed, Wood Scraping"
  },
  {
    "source": "Scraping Bottles",
    "targets": ""
  },
  {
    "source": "Shaking Metal Tower",
    "targets": "Tapping Metal Tower"
  },
  {
    "source": "Rattling Metal Tower",
    "targets": "Shaking Metal Tower"
  },
  {
    "source": "Pounding Metal Tower",
    "targets": "Infrastructure"
  },
  {
    "source": "Tapping Metal Tower",
    "targets": "Pounding Metal Tower"
  },
  {
    "source": "Opening Latch",
    "targets": "Door Hinge"
  },
  {
    "source": "Leaf Rustling in Hand",
    "targets": ""
  },
  {
    "source": "Insect Repellant",
    "targets": ""
  },
  {
    "source": "Hose Handle",
    "targets": ""
  },
  {
    "source": "Gardener Talking",
    "targets": "Beanstalk, Basil Plant, Watering Plants, Scraping Bottles, Asking a Question"
  },
  {
    "source": "Eating Tomato",
    "targets": "Tomato Plants"
  },
  {
    "source": "Drawer in Shed",
    "targets": "Nails in Shed"
  },
  {
    "source": "Door Slam",
    "targets": ""
  },
  {
    "source": "Door Hinge",
    "targets": "Door Slam"
  },
  {
    "source": "Nails in Shed",
    "targets": ""
  },
  {
    "source": "Asking a Question",
    "targets": "Insect Repellant"
  },
  {
    "source": "Wood Tapping",
    "targets": ""
  },
  {
    "source": "Wood Scraping",
    "targets": "Wood Tapping, Water Timer Clicking"
  },
  {
    "source": "Water Timer Clicking",
    "targets": ""
  },
  {
    "source": "Sound Artist Conversation",
    "targets": "Sunflower Stalk, Tomato Plants, Rustling Squash Leaves"
  },
  {
    "source": "Infrastructure",
    "targets": "Shed Floor, Road Noises, Light Ballast, Birdsong/Car Noise, Rattling Metal Tower, Water Lapping, Opening Latch, Insect Repellant"
  },
  {
    "source": "Machines",
    "targets": "Motorcycle Idling, Bird/Siren, Sirens and Rowers, Helicopter Landing, Crickets and Airplane, Bike, Car Acceleration, Airplane, Rattling Metal Tower, Airplane"
  },
  {
    "source": "Labor",
    "targets": "Watering Plants, Breaking Branches, Digging, Rowers, Learning about Roots,"
  },
  {
    "source": "Body",
    "targets": "Breathing, Footsteps, Eating Tomato, Brushing against Plants, Rubbing Leaves, Rustling Squash Leaves, Bird Drops her Nut, Wood Scraping, Heartbeat"
  },
  {
    "source": "Flora",
    "targets": "Sunflower Stalk, Learning about Roots, Shaking Dead Tree, Log Falling, Bees 1, Rustling Squash Leaves, Rubbing Leaves, Windy Leaves, Brushing against Plants"
  },
  {
    "source": "Fauna",
    "targets": "Cicadas, Birdsong 1, Birdsong 2, Bird Call 1, Bird Call 2, Crickets, Birds and Ducks, Ducks Bathing, Bees 1, Bees 2, Bird Drops her Nut"
  },
  {
    "source": "Community",
    "targets": "Sirens and Rowers, Learning about Roots, Eating Tomato, Rowers, Children's Speech, Gardener Talking, Sound Artist Conversation"
  },
  {
    "source": "Earth",
    "targets": "Breathing, Log Falling, Stomping, Digging, Ducks Bathing, Ambience, Airplane, Windy Leaves, Footsteps, Water Lapping"
  }
]
        };
        
        // --- DATA PROCESSING ---
        soundscapeData.nodes.forEach(n => {
            if (n.Group) {
                n.group = n.Group;
                delete n.Group;
            }
        });
        
        const nodeIds = new Set(soundscapeData.nodes.map(n => n.id));
        
        const processedLinks = [];
        soundscapeData.links.forEach(link => {
            if (link.source && nodeIds.has(link.source) && link.targets) {
                const targets = link.targets.split(',').map(t => t.trim());
                targets.forEach(target => {
                    if (target && nodeIds.has(target)) {
                        processedLinks.push({ source: link.source, target: target });
                    }
                });
            }
        });

        // --- GLOBAL SETTINGS ---
        const settings = {
            nodeOpacity: 0.15,
            inactiveNodeOpacity: 0.35, // New setting
            inactiveLinkOpacity: 0.25, // New setting
            nodeSize: 20,
            glareOpacity: .25,
            nodeStrokeWeight: .5,
            linkOpacity: 0.6,
            forceCharge: -600,
            linkDistance: 220,
            masterVolume: 1.0,
            maxNeighbors: 4
        };
        
        // --- AUTOPLAY STATE ---
        let isAutoPlayMode = false;
        let autoPlayTimer = null;
        const autoPlayIntervalTime = 30000; // 30 seconds

        // --- SETUP ---
        const width = window.innerWidth;
        const height = window.innerHeight;

        const svg = d3.select("#graph-container")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .on("click", () => stopAllSoundsMode()); // Stop everything on bg click

        // ADDED: SVG Definitions for Glass/Gradient Effects
        const defs = svg.append("defs");

        // Radial Gradient for Glass Beads
        const radialGradient = defs.append("radialGradient")
            .attr("id", "glass-gradient")
            .attr("cx", "30%")
            .attr("cy", "30%")
            .attr("r", "70%");
        
        radialGradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "rgba(255,255,255,0.8)"); // Highlight
        
        radialGradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "rgba(255,255,255,0.0)"); // Transparent edge

        // Drop Shadow Filter
        const filter = defs.append("filter")
            .attr("id", "drop-shadow")
            .attr("height", "130%");
        
        filter.append("feGaussianBlur")
            .attr("in", "SourceAlpha")
            .attr("stdDeviation", 3)
            .attr("result", "blur");
        
        filter.append("feOffset")
            .attr("in", "blur")
            .attr("dx", 2)
            .attr("dy", 2)
            .attr("result", "offsetBlur");
            
        const feMerge = filter.append("feMerge");
        feMerge.append("feMergeNode").attr("in", "offsetBlur");
        feMerge.append("feMergeNode").attr("in", "SourceGraphic");

        
        const container = svg.append("g");

        // Updated Palette for Dark Background
        const customColors = ["#A9DEF9", "#FF99C8", "#E4C1F9", "#D0F4DE", "#FCF6BD"]; 
        const color = d3.scaleOrdinal(customColors);

        const simulation = d3.forceSimulation(soundscapeData.nodes)
            .force("link", d3.forceLink(processedLinks).id(d => d.id).distance(settings.linkDistance)) 
            .force("charge", d3.forceManyBody().strength(settings.forceCharge)) 
            .force("center", d3.forceCenter(width / 2, height / 2));

        const link = container.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(processedLinks)
            .enter().append("line")
            .attr("class", "link")
            .style("stroke", d => {
                if (d.source.group === "category" || d.target.group === "category") {
                    return "#99ad99"; // UPDATED: Desaturated Sage Green
                }
                return "rgba(255, 255, 255, 1)"; 
            })
            .style("stroke-opacity", settings.linkOpacity)
            .style("stroke-width", "1px");

        const node = container.append("g")
            .attr("class", "nodes")
            .selectAll("g")
            .data(soundscapeData.nodes)
            .enter().append("g")
            .attr("class", "node");
        
        // 1. Base Circle (The Color)
        const baseCircles = node.append("circle")
            .attr("class", "base-circle")
            .attr("r", settings.nodeSize)
            .attr("fill", d => {
                if (d.group === "category") {
                    return "rgba(144, 169, 134, 0.8)"; 
                }
                return color(d.group);
            })
            .attr("fill-opacity", settings.nodeOpacity) // Uses dynamic setting
            .attr("stroke", "rgba(255,255,255,0.6)") 
            .attr("stroke-width", settings.nodeStrokeWeight)
            .style("filter", "url(#drop-shadow)"); 

        // 2. Glass Shine Overlay (The Reflection)
        const shineCircles = node.append("circle")
            .attr("class", "shine-circle")
            .attr("r", settings.nodeSize)
            .attr("fill", "url(#glass-gradient)") 
            .attr("fill-opacity", settings.glareOpacity)
            .style("pointer-events", "none"); 

        node.append("text")
            .text(d => d.id)
            .attr("x", settings.nodeSize + 8)
            .attr("y", 5)
            .style("font-size", "12px")
            .style("fill", "#e2e8f0"); 

        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);
            node
                .attr("transform", d => `translate(${d.x},${d.y})`);
            
            node.select('text')
                .attr("x", d => d.x > width / 2 ? -(settings.nodeSize + 8) : (settings.nodeSize + 8))
                .style("text-anchor", d => d.x > width / 2 ? "end" : "start");
        });

        // --- AUDIO LOGIC ---
        let audioContext;
        let masterGainNode;
        let audioBuffers = {};
        let playingSources = [];
        let playingNeighbors = new Set();
        let neighborPool = [];
        let activeNodeId = null; 
        
        async function getAudioBuffer(soundUrl) {
            if (audioBuffers[soundUrl]) return audioBuffers[soundUrl];
            try {
                const response = await fetch(soundUrl);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                audioBuffers[soundUrl] = audioBuffer;
                return audioBuffer;
            } catch (error) {
                console.error(`Error loading sound from ${soundUrl}:`, error);
            }
        }
        
        function initAudio() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    masterGainNode = audioContext.createGain();
                    masterGainNode.gain.value = settings.masterVolume;
                    masterGainNode.connect(audioContext.destination);
                } catch (e) {
                    console.error("Web Audio API is not supported in this browser");
                }
            }
        }

        function playSound(buffer, { volume = 1.0, loop = false, onended = null }) {
            if (!buffer || !audioContext) return;
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.loop = loop;

            const panner = audioContext.createStereoPanner();
            const gainNode = audioContext.createGain();

            const setRandomPan = () => {
                if (buffer.numberOfChannels === 1) {
                    panner.pan.value = Math.random() < 0.5 ? -0.75 : 0.75;
                } else {
                    panner.pan.value = 0;
                }
            };
            
            setRandomPan(); 

            // Ramp up local gain
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 1);
            
            // Connect chain: Source -> Panner -> Gain -> MasterGain -> Destination
            source.connect(panner).connect(gainNode).connect(masterGainNode);
            source.start(0);
            
            let panInterval = null;
            if (loop && buffer.numberOfChannels === 1) {
                panInterval = setInterval(setRandomPan, buffer.duration * 1000);
            }
            
            if (onended) {
                source.onended = () => {
                    if (panInterval) clearInterval(panInterval);
                    onended();
                };
            }
            source.panInterval = panInterval;
            playingSources.push(source);
        }

        // Stops sounds but keeps AutoPlay state intact (helper)
        function stopAllSoundsCore() {
            playingSources.forEach(source => {
                if (source.panInterval) clearInterval(source.panInterval);
                source.onended = null; 
                source.stop();
            });
            playingSources = [];
            playingNeighbors.clear();
            neighborPool = [];
            activeNodeId = null; 
            updateOpacities(); 
        }

        // Full Stop (UI button)
        function stopAllSoundsMode() {
            // Disable AutoPlay mode
            isAutoPlayMode = false;
            clearTimeout(autoPlayTimer);
            updateControlButtons();
            
            // Stop Audio
            stopAllSoundsCore();
        }

        // --- VISUAL STATE ---
        function updateOpacities(hoveredData = null) {
            const searchTerm = d3.select("#search-bar").property("value").toLowerCase();
            const searchActive = searchTerm.length > 0;

            if (hoveredData) {
                const neighborIds = new Set(processedLinks
                    .filter(l => l.source.id === hoveredData.id || l.target.id === hoveredData.id)
                    .map(l => l.source.id === hoveredData.id ? l.target.id : l.source.id)
                );
                neighborIds.add(hoveredData.id);

                d3.selectAll('.node').style('opacity', n => neighborIds.has(n.id) ? 1.0 : settings.inactiveNodeOpacity); 
                d3.selectAll('.node text').style('opacity', n => neighborIds.has(n.id) ? 1.0 : settings.inactiveNodeOpacity);
                d3.selectAll('.link').style('stroke-opacity', l => (l.source.id === hoveredData.id || l.target.id === hoveredData.id) ? 0.8 : settings.inactiveLinkOpacity);
                return;
            }

            if (searchActive) {
                const matchingNodeIds = new Set(soundscapeData.nodes.filter(n => n.id.toLowerCase().includes(searchTerm)).map(n => n.id));
                d3.selectAll('.node, .node text').style('opacity', n => matchingNodeIds.has(n.id) ? 1.0 : settings.inactiveNodeOpacity);
                d3.selectAll('.link').style('stroke-opacity', settings.inactiveLinkOpacity);
                return;
            }

            if (!activeNodeId) {
                d3.selectAll('.node, .node text').style('opacity', 1.0);
                d3.selectAll('.link').style('stroke-opacity', settings.linkOpacity);
                // Reset strokes
                d3.selectAll('.node circle.base-circle')
                    .attr('stroke', 'rgba(255,255,255,0.6)')
                    .attr('stroke-width', settings.nodeStrokeWeight);
                return;
            }

            d3.selectAll('.node').style('opacity', function(nodeData) {
                const isClicked = nodeData.id === activeNodeId;
                const isPlaying = playingNeighbors.has(nodeData.id);
                if (isClicked || isPlaying) return 1.0;
                return settings.inactiveNodeOpacity; // Use inactive setting
            });

            d3.selectAll('.node text').style('opacity', function(nodeData) {
                const isClicked = nodeData.id === activeNodeId;
                const isPlaying = playingNeighbors.has(nodeData.id);
                return (isClicked || isPlaying) ? 1.0 : settings.inactiveNodeOpacity;
            });
            
            // Highlight Rings
            d3.selectAll('.node circle.base-circle').attr('stroke', function(nodeData){
                const isClicked = nodeData.id === activeNodeId;
                const isPlaying = playingNeighbors.has(nodeData.id);
                if(isClicked) return '#fff';
                if(isPlaying) return '#d1fae5';
                return 'rgba(255,255,255,0.6)';
            }).attr('stroke-width', function(nodeData){
                const isClicked = nodeData.id === activeNodeId;
                const isPlaying = playingNeighbors.has(nodeData.id);
                // Add highlight weight on top of base weight
                if(isClicked) return settings.nodeStrokeWeight + 2;
                if(isPlaying) return settings.nodeStrokeWeight + 1;
                return settings.nodeStrokeWeight;
            });
            
            d3.selectAll('.link').style('stroke-opacity', function(linkData) {
                const isClickedSource = linkData.source.id === activeNodeId;
                const isClickedTarget = linkData.target.id === activeNodeId;
                const isPlayingSource = playingNeighbors.has(linkData.source.id);
                const isPlayingTarget = playingNeighbors.has(linkData.target.id);

                if ((isClickedSource && isPlayingTarget) || (isClickedTarget && isPlayingSource)) {
                    return 0.8; // UPDATED: Brightened to match hover highlight (was 0.6)
                }
                return settings.inactiveLinkOpacity;
            });
        }
        
        // --- ACTIVATION LOGIC (Refactored for reuse) ---
        async function activateNode(d) {
            initAudio(); // Ensure audio context starts on interaction
            d3.select("#search-bar").property("value", ""); 
            
            // Stop current sounds, but DON'T reset the AutoPlay mode yet
            stopAllSoundsCore();
            
            activeNodeId = d.id;

            // NEW: Smooth Pan to Center the Active Node
            // We calculate the translation needed to put the node (d.x, d.y) in the center (width/2, height/2)
            // preserving the current zoom level (k).
            const currentTransform = d3.zoomTransform(svg.node());
            const scale = currentTransform.k;
            const x = -d.x * scale + width / 2;
            const y = -d.y * scale + height / 2;
            
            svg.transition()
                .duration(1200) // 1.2s smooth pan
                .ease(d3.easeCubicOut)
                .call(zoom.transform, d3.zoomIdentity.translate(x, y).scale(scale));

            const clickedNodeData = soundscapeData.nodes.find(node => node.id === d.id);
            if (clickedNodeData && clickedNodeData.sound) {
                const buffer = await getAudioBuffer(clickedNodeData.sound);
                if (buffer) {
                    playSound(buffer, { volume: 1.0, loop: true });
                }
            }
            
            const allNeighborIds = [...new Set(processedLinks
                .filter(link => (link.source.id === d.id || link.target.id === d.id))
                .map(link => link.source.id === d.id ? link.target.id : link.source.id))];

            neighborPool = allNeighborIds.filter(id => {
                const node = soundscapeData.nodes.find(n => n.id === id);
                return node && node.sound && node.sound.trim() !== "";
            });
            
            const playNextNeighbor = (finishedNeighborId = null) => {
                if (finishedNeighborId) {
                    playingNeighbors.delete(finishedNeighborId);
                }
                
                // Safety check: if we stopped playing, stop recursion
                if (!activeNodeId) return;

                if (playingNeighbors.size >= settings.maxNeighbors) {
                    updateOpacities();
                    return;
                }

                const availableNeighbors = neighborPool.filter(id => !playingNeighbors.has(id));

                if (availableNeighbors.length > 0) {
                    const nextNeighborId = availableNeighbors[Math.floor(Math.random() * availableNeighbors.length)];
                    playingNeighbors.add(nextNeighborId);

                    const neighborNodeData = soundscapeData.nodes.find(node => node.id === nextNeighborId);
                    
                    getAudioBuffer(neighborNodeData.sound).then(buffer => {
                        // Check activeNodeId again before playing to prevent zombie sounds
                        if (buffer && activeNodeId) {
                            playSound(buffer, {
                                volume: 0.25,
                                loop: false,
                                onended: () => playNextNeighbor(nextNeighborId)
                            });
                        }
                    });
                }
                updateOpacities();
            };

            const initialCount = Math.min(neighborPool.length, settings.maxNeighbors);
            for (let i = 0; i < initialCount; i++) {
                playNextNeighbor();
            }
            updateOpacities();

            // Handle AutoPlay Timer Reset
            if (isAutoPlayMode) {
                clearTimeout(autoPlayTimer);
                autoPlayTimer = setTimeout(triggerRandomNode, autoPlayIntervalTime);
            }
        }

        // --- AUTOPLAY LOGIC ---
        function startAutoPlayMode() {
            initAudio();
            isAutoPlayMode = true;
            updateControlButtons();
            triggerRandomNode();
        }

        function triggerRandomNode() {
            if (!isAutoPlayMode) return;
            
            // MODIFIED: Filter only for "category" nodes (the green hubs)
            const categoryNodes = soundscapeData.nodes.filter(n => n.group === "category");
            
            if (categoryNodes.length > 0) {
                // Pick a random category node
                const randomNode = categoryNodes[Math.floor(Math.random() * categoryNodes.length)];
                
                // Simulate activation
                activateNode(randomNode);
            }
        }

        function updateControlButtons() {
            const playBtn = document.getElementById('btn-play');
            if (isAutoPlayMode) {
                playBtn.classList.add('active-mode');
            } else {
                playBtn.classList.remove('active-mode');
            }
        }

        // --- INTERACTION HANDLERS ---
        node.on("click", function(event, d) {
            event.stopPropagation();
            activateNode(d);
        });
        
        // Button Handlers
        document.getElementById('btn-play').addEventListener('click', (e) => {
            e.stopPropagation();
            startAutoPlayMode();
        });

        document.getElementById('btn-stop').addEventListener('click', (e) => {
            e.stopPropagation();
            stopAllSoundsMode();
        });


        node.on("mouseover", (event, d) => updateOpacities(d))
            .on("mouseout", () => updateOpacities());

        d3.select("#search-bar").on("input", () => {
            stopAllSoundsMode();
            updateOpacities();
        });
        
        const drag = d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended);
        
        node.call(drag);

        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }

        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }

        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }
            
        // --- ZOOM & RESIZE ---
        const zoom = d3.zoom()
            .scaleExtent([0.2, 5]) 
            .on('zoom', (event) => {
                container.attr('transform', event.transform);
            });

        svg.call(zoom);
        
        window.addEventListener('resize', () => {
            const newWidth = window.innerWidth;
            const newHeight = window.innerHeight;
            svg.attr('width', newWidth).attr('height', newHeight);
            simulation.force('center', d3.forceCenter(newWidth / 2, newHeight / 2)).restart();
        });
        
        // --- UI & SETTINGS HANDLERS ---
        const settingsToggle = document.getElementById('settings-toggle');
        const settingsPanel = document.getElementById('settings-panel');
        settingsToggle.addEventListener('click', () => {
            settingsPanel.classList.toggle('hidden-panel');
        });

        document.getElementById('input-opacity').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            settings.nodeOpacity = val;
            document.getElementById('val-opacity').textContent = val;
            d3.selectAll('.base-circle').attr('fill-opacity', val);
            if(!activeNodeId) updateOpacities(); 
        });

        document.getElementById('input-inactive-node').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            settings.inactiveNodeOpacity = val;
            document.getElementById('val-inactive-node').textContent = val;
            updateOpacities(); // Update immediately if active
        });

        document.getElementById('input-inactive-link').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            settings.inactiveLinkOpacity = val;
            document.getElementById('val-inactive-link').textContent = val;
            updateOpacities(); // Update immediately if active
        });
        
        document.getElementById('input-glare').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            settings.glareOpacity = val;
            document.getElementById('val-glare').textContent = val;
            d3.selectAll('.shine-circle').attr('fill-opacity', val);
        });

        document.getElementById('input-link').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            settings.linkOpacity = val;
            document.getElementById('val-link').textContent = val;
            if(!activeNodeId) {
                d3.selectAll('.link').style('stroke-opacity', val);
            }
        });

        document.getElementById('input-stroke').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            settings.nodeStrokeWeight = val;
            document.getElementById('val-stroke').textContent = val;
            updateOpacities(); // Re-apply widths
        });

        document.getElementById('input-size').addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            settings.nodeSize = val;
            document.getElementById('val-size').textContent = val;
            d3.selectAll('.base-circle, .shine-circle').attr('r', val);
            d3.selectAll('text').attr('x', val + 8);
            simulation.restart(); 
        });

        document.getElementById('input-charge').addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            settings.forceCharge = val;
            document.getElementById('val-charge').textContent = val;
            simulation.force("charge", d3.forceManyBody().strength(val));
            simulation.alpha(0.3).restart();
        });

        document.getElementById('input-distance').addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            settings.linkDistance = val;
            document.getElementById('val-distance').textContent = val;
            simulation.force("link", d3.forceLink(processedLinks).id(d => d.id).distance(val));
            simulation.alpha(0.3).restart();
        });

        document.getElementById('input-volume').addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            settings.masterVolume = val;
            document.getElementById('val-volume').textContent = val.toFixed(1);
            if(audioContext && masterGainNode) {
                masterGainNode.gain.setTargetAtTime(val, audioContext.currentTime, 0.1);
            }
        });

        document.getElementById('input-neighbors').addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            settings.maxNeighbors = val;
            document.getElementById('val-neighbors').textContent = val;
        });

    </script>
</body>
</html>
